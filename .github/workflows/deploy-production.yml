name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production  # Access environment secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        env:
          SSHPASS: ${{ secrets.SSH_PASSPHRASE }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          sshpass -e ssh -T -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 "${SERVER_USER}@${SERVER_IP}" << 'EOFMARKER'
          set -e

          echo "ðŸš€ Starting production deployment..."

          # Navigate to app directory
          cd /opt/homeschool-app-production || mkdir -p /opt/homeschool-app-production && cd /opt/homeschool-app-production

          # Clone or pull latest code
          if [ -d ".git" ]; then
            echo "ðŸ“¦ Pulling latest changes from production branch..."
            git fetch origin
            git checkout production
            git pull origin production
          else
            echo "ðŸ“¦ Cloning repository..."
            git clone -b production https://github.com/${{ github.repository }}.git .
          fi

          # Stop and remove existing containers
          echo "ðŸ›‘ Stopping existing containers..."
          docker-compose -f docker-compose.production.yml down || true

          # Build and start containers with secrets
          echo "ðŸ—ï¸  Building and starting containers..."
          JWT_SECRET="${{ secrets.JWT_SECRET }}" \
          JWT_REFRESH_SECRET="${{ secrets.JWT_REFRESH_SECRET }}" \
          OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
          AI_MODEL="${{ secrets.AI_MODEL }}" \
          SITE_NAME="${{ secrets.SITE_NAME }}" \
          FLUTTERWAVE_PUBLIC_KEY="${{ secrets.FLUTTERWAVE_PUBLIC_KEY }}" \
          FLUTTERWAVE_SECRET_KEY="${{ secrets.FLUTTERWAVE_SECRET_KEY }}" \
          FLUTTERWAVE_ENCRYPTION_KEY="${{ secrets.FLUTTERWAVE_ENCRYPTION_KEY }}" \
          FLUTTERWAVE_WEBHOOK_SECRET="${{ secrets.FLUTTERWAVE_WEBHOOK_SECRET }}" \
          SMTP_HOST="${{ secrets.SMTP_HOST }}" \
          SMTP_PORT="${{ secrets.SMTP_PORT }}" \
          SMTP_USER="${{ secrets.SMTP_USER }}" \
          SMTP_PASS="${{ secrets.SMTP_PASS }}" \
          GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
          GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
          ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}" \
          ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" \
          docker-compose -f docker-compose.production.yml up -d --build

          # Clean up old images
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo "âœ… Production deployment complete!"
          echo "ðŸ“Š Container status:"
          docker-compose -f docker-compose.production.yml ps

          echo ""
          echo "ðŸŒ Production application is available at:"
          echo "   Frontend: http://${{ secrets.SERVER_IP }}:5005"
          echo "   Backend API: http://${{ secrets.SERVER_IP }}:5004"

          # Force exit to close SSH session
          exit 0
          EOFMARKER

      - name: Notify deployment status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… Production deployment succeeded"
          else
            echo "âŒ Production deployment failed"
            exit 1
          fi
