generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PARENT
  TEACHER
  STUDENT
}

// Billing & Payments
enum BillingInterval {
  MONTH
  YEAR
  CUSTOM_DAYS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentProvider {
  FLUTTERWAVE
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  LONG_ANSWER
  FILL_BLANKS
  MATCHING
  ORDERING
  MATH_PROBLEM
  CODING
  DIAGRAM
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum GradingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REVIEWED
}

model User {
  id                String    @id @default(cuid())
  email             String?   @unique
  username          String?   @unique
  password          String?
  firstName         String?
  lastName          String?
  name              String?
  role              Role      @default(STUDENT)
  emailVerified     DateTime?
  image             String?
  
  // Relations
  parentId          String?
  parent            User?     @relation("ParentChild", fields: [parentId], references: [id])
  children          User[]    @relation("ParentChild")
  
  // Teacher relations
  createdById       String?
  createdBy         User?     @relation("CreatedUsers", fields: [createdById], references: [id])
  createdUsers      User[]    @relation("CreatedUsers")
  
  createdExams      Exam[]    @relation("ExamCreator")
  examAttempts      ExamAttempt[]
  grades            Grade[]
  
  // Assignment relations
  assignedExams     ExamAssignment[] @relation("StudentAssignments")
  createdAssignments ExamAssignment[] @relation("AssignmentCreator")
  
  // Class relations
  classesAsStudent  ClassStudent[]
  classesAsTeacher  Class[]   @relation("ClassTeacher")
  createdClasses    Class[]   @relation("ClassCreator")
  
  // Portfolio relations
  portfolios        Portfolio[] @relation("StudentPortfolio")
  
  // Community relations
  communityPosts    CommunityPost[] @relation("CommunityPosts")
  postLikes         PostLike[] @relation("PostLikes")
  
  // Performance tracking
  performanceData   StudentPerformanceData[] @relation("PerformanceData")
  
  // Standards tracking
  standardProgress  StudentStandardProgress[] @relation("StudentStandardProgress")
  
  // Lesson plan relations
  createdLessonPlans LessonPlan[] @relation("CreatedLessonPlans")
  lessonAssignments LessonPlanAssignment[] @relation("StudentLessonAssignments")  
  createdLessonAssignments LessonPlanAssignment[] @relation("LessonAssignmentCreator")
  
  // Study module relations (Interactive Learning)
  createdStudyModules StudyModule[] @relation("CreatedStudyModules")
  studyAssignments StudyModuleAssignment[] @relation("StudentStudyAssignments")
  createdStudyAssignments StudyModuleAssignment[] @relation("StudyAssignmentCreator")
  stepProgress StudentStepProgress[] @relation("StudentStepProgress")
  studyProgress StudyProgress[] @relation("StudentProgress")

  // Billing
  subscriptions Subscription[]
  payments      Payment[]
  
  // OAuth Accounts
  accounts      Account[]

  // Tier relation
  tier              UserTier?

  // System fields
  isActive          Boolean   @default(true)
  lastLogin         DateTime?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  @@map("users")
}

// NextAuth models for OAuth and email flows
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Exam {
  id                String        @id @default(cuid())
  title             String
  description       String?
  subject           String
  gradeLevel        Int
  
  // AI Generation Config
  aiGenerated       Boolean       @default(true)
  aiConfig          Json?         // Stores AI generation parameters
  
  // Exam Settings
  duration          Int?          // in minutes
  totalMarks        Int           @default(100)
  passingMarks      Int           @default(50)
  
  // Result publishing settings
  autoPublishResults Boolean      @default(true) // true = immediate, false = manual
  
  status            ExamStatus    @default(DRAFT)
  scheduledFor      DateTime?
  
  // Relations
  creatorId         String
  creator           User          @relation("ExamCreator", fields: [creatorId], references: [id])
  
  questions         Question[]
  attempts          ExamAttempt[]
  assignments       ExamAssignment[]
  
  // Curriculum standards
  standards         CurriculumStandard[] @relation("ExamStandards")
  
  // Metadata
  instructions      String?
  allowedResources  String[]      @default([])
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@index([creatorId])
  @@map("exams")
}

model Question {
  id                String        @id @default(cuid())
  examId            String
  exam              Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  type              QuestionType
  question          String        @db.Text
  
  // Different answer formats based on type
  options           Json?         // For MCQ, matching
  correctAnswer     Json          // Can be string, array, or object based on type
  
  // File attachments for rich questions
  imageUrl          String?       // Question image/diagram
  attachments       String[]      @default([]) // Additional files
  
  marks             Int           @default(5)
  
  // AI specific fields
  aiGenerated       Boolean       @default(true)
  difficulty        String?       // easy, medium, hard
  topic             String?
  
  // For better grading
  gradingRubric     Json?         // AI grading criteria
  sampleAnswer      String?       @db.Text
  
  order             Int           @default(0)
  
  // Relations
  answers           Answer[]
  standards         CurriculumStandard[] @relation("QuestionStandards")
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@index([examId])
  @@map("questions")
}

model ExamAttempt {
  id                String        @id @default(cuid())
  
  examId            String
  exam              Exam          @relation(fields: [examId], references: [id])
  
  studentId         String
  student           User          @relation(fields: [studentId], references: [id])
  
  startedAt         DateTime      @default(now())
  submittedAt       DateTime?
  timeSpent         Int?          // in minutes
  
  // Status
  isCompleted       Boolean       @default(false)
  isGraded          Boolean       @default(false)
  
  // Relations
  answers           Answer[]
  grade             Grade?
  
  @@unique([examId, studentId])
  @@index([studentId])
  @@map("exam_attempts")
}

model Answer {
  id                String        @id @default(cuid())
  
  attemptId         String
  attempt           ExamAttempt   @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId        String
  question          Question      @relation(fields: [questionId], references: [id])
  
  // Student's answer
  answer            Json          // Can store any type of answer
  
  // File submissions
  submittedFiles    String[]      @default([]) // Student uploaded files
  
  // AI Grading
  aiScore           Float?        // Score given by AI
  aiFeedback        String?       @db.Text
  aiGradedAt        DateTime?
  
  // Manual override
  manualScore       Float?
  manualFeedback    String?       @db.Text
  reviewedBy        String?
  
  finalScore        Float?        // Final score (manual overrides AI)
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@index([attemptId])
  @@map("answers")
}

model Grade {
  id                String        @id @default(cuid())
  
  attemptId         String        @unique
  attempt           ExamAttempt   @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  studentId         String
  student           User          @relation(fields: [studentId], references: [id])
  
  totalScore        Float
  percentage        Float
  grade             String?       // A, B, C, etc.
  
  status            GradingStatus @default(PENDING)
  
  // AI Analysis
  aiAnalysis        Json?         // Strengths, weaknesses, recommendations
  
  // Feedback
  overallFeedback   String?       @db.Text
  
  // Publishing
  isPublished       Boolean       @default(false)
  publishedAt       DateTime?
  publishedBy       String?
  
  gradedAt          DateTime      @default(now())
  
  @@index([studentId])
  @@map("grades")
}

model Class {
  id                String        @id @default(cuid())
  name              String
  description       String?
  gradeLevel        Int?
  subject           String?
  
  // Relations
  teacherId         String
  teacher           User          @relation("ClassTeacher", fields: [teacherId], references: [id])
  
  createdById       String
  createdBy         User          @relation("ClassCreator", fields: [createdById], references: [id])
  
  students          ClassStudent[]
  examAssignments   ExamAssignment[]
  lessonAssignments LessonPlanAssignment[]
  
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@index([teacherId])
  @@index([createdById])
  @@map("classes")
}

model ClassStudent {
  id                String        @id @default(cuid())
  
  classId           String
  class             Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  studentId         String
  student           User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  joinedAt          DateTime      @default(now())
  
  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@map("class_students")
}

model ExamAssignment {
  id                String        @id @default(cuid())
  
  examId            String
  exam              Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Can be assigned to individual students or classes
  studentId         String?
  student           User?         @relation("StudentAssignments", fields: [studentId], references: [id])
  
  classId           String?
  class             Class?        @relation(fields: [classId], references: [id])
  
  assignedBy        String
  assignedByUser    User          @relation("AssignmentCreator", fields: [assignedBy], references: [id])
  
  // Assignment settings
  dueDate           DateTime?
  startDate         DateTime?
  allowLateSubmission Boolean     @default(false)
  maxAttempts       Int           @default(1)
  
  // Status tracking
  isActive          Boolean       @default(true)
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@index([classId])
  @@index([assignedBy])
  @@map("exam_assignments")
}

model SystemSettings {
  id                String        @id @default(cuid())
  key               String        @unique
  value             Json
  description       String?
  
  updatedAt         DateTime      @updatedAt
  
  @@map("system_settings")
}

model AuditLog {
  id                String        @id @default(cuid())
  userId            String
  action            String
  entity            String
  entityId          String?
  metadata          Json?
  
  createdAt         DateTime      @default(now())
  
  @@index([userId])
  @@map("audit_logs")
}

model Portfolio {
  id          String    @id @default(cuid())
  studentId   String
  student     User      @relation("StudentPortfolio", fields: [studentId], references: [id], onDelete: Cascade)
  
  title       String
  description String?   @db.Text
  isPublic    Boolean   @default(false)
  
  items       PortfolioItem[]
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([studentId])
  @@map("portfolios")
}

model PortfolioItem {
  id            String     @id @default(cuid())
  portfolioId   String
  portfolio     Portfolio  @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?    @db.Text
  type          PortfolioItemType
  content       Json       // Stores different content based on type
  subject       String?
  tags          String[]   @default([])
  
  // File attachments
  attachments   String[]   @default([]) // File URLs
  
  // Reflection and learning
  reflection    String?    @db.Text
  learningGoals String[]   @default([])
  skills        String[]   @default([])
  
  // Assessment data
  grade         String?
  feedback      String?    @db.Text
  assessedBy    String?
  assessedAt    DateTime?
  
  // Metadata
  completedAt   DateTime?
  isPublished   Boolean    @default(false)
  order         Int        @default(0)
  
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  
  @@index([portfolioId])
  @@map("portfolio_items")
}

enum PortfolioItemType {
  ASSIGNMENT
  PROJECT
  ARTWORK
  WRITING
  VIDEO
  AUDIO
  PHOTO
  PRESENTATION
  RESEARCH
  EXPERIMENT
  FIELD_TRIP
  REFLECTION
  ACHIEVEMENT
  CERTIFICATE
}

model CommunityPost {
  id          String      @id @default(cuid())
  authorId    String
  author      User        @relation("CommunityPosts", fields: [authorId], references: [id])
  
  title       String
  content     String      @db.Text
  type        PostType
  category    String?     // Subject area or topic
  tags        String[]    @default([])
  
  // Forum/Discussion features
  parentId    String?     // For replies
  parent      CommunityPost? @relation("PostReplies", fields: [parentId], references: [id])
  replies     CommunityPost[] @relation("PostReplies")
  
  // Engagement
  likes       PostLike[]
  views       Int         @default(0)
  
  // Moderation
  isPublished Boolean     @default(true)
  isPinned    Boolean     @default(false)
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  @@index([authorId])
  @@index([type])
  @@index([category])
  @@map("community_posts")
}

enum PostType {
  QUESTION
  DISCUSSION
  RESOURCE
  SUCCESS_STORY
  TIP
  ANNOUNCEMENT
}

model PostLike {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation("PostLikes", fields: [userId], references: [id])
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime      @default(now()) @map("created_at")
  
  @@unique([userId, postId])
  @@index([postId])
  @@map("post_likes")
}

model StudentPerformanceData {
  id            String   @id @default(cuid())
  studentId     String
  student       User     @relation("PerformanceData", fields: [studentId], references: [id])
  
  subject       String
  topic         String?
  skillLevel    Int      @default(1) // 1-10 scale
  difficultyPreference Int @default(5) // 1-10 scale
  
  // Performance metrics
  accuracy      Float    @default(0.0) // 0-100%
  speed         Float?   // Questions per minute
  consistency   Float    @default(0.0) // Performance variance
  
  // Learning style preferences
  preferredQuestionTypes String[] @default([])
  strengths     String[] @default([])
  weaknesses    String[] @default([])
  
  // Adaptive testing data
  lastExamScore Float?
  trending      String   @default("STABLE") // IMPROVING, DECLINING, STABLE
  
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@unique([studentId, subject])
  @@index([studentId])
  @@map("student_performance_data")
}

model CurriculumStandard {
  id          String   @id @default(cuid())
  country     String   // US, UK, AU, NZ
  system      String   // Common Core, National Curriculum, etc.
  subject     String
  gradeLevel  Int
  
  code        String   // Standard code (e.g., CCSS.MATH.1.OA.A.1)
  title       String
  description String   @db.Text
  category    String?  // Algebra, Reading, Science, etc.
  
  // Learning objectives
  objectives  String[] @default([])
  skills      String[] @default([])
  
  // Linked questions and exams
  questions   Question[] @relation("QuestionStandards")
  exams       Exam[]     @relation("ExamStandards")
  
  // Student progress tracking
  studentProgress StudentStandardProgress[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@unique([country, system, code])
  @@index([country, system])
  @@index([subject, gradeLevel])
  @@map("curriculum_standards")
}

model StudentStandardProgress {
  id           String   @id @default(cuid())
  studentId    String
  student      User     @relation("StudentStandardProgress", fields: [studentId], references: [id])
  
  standardId   String
  standard     CurriculumStandard @relation(fields: [standardId], references: [id])
  
  // Progress tracking
  status       StandardStatus @default(NOT_STARTED)
  mastery      Float    @default(0.0) // 0-100%
  attempts     Int      @default(0)
  
  // Timestamps
  startedAt    DateTime?
  masteredAt   DateTime?
  lastAttempt  DateTime?
  
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@unique([studentId, standardId])
  @@index([studentId])
  @@index([standardId])
  @@map("student_standard_progress")
}

enum StandardStatus {
  NOT_STARTED
  IN_PROGRESS
  MASTERED
  NEEDS_REVIEW
}

model LessonPlan {
  id            String   @id @default(cuid())
  title         String
  topic         String
  subject       String
  gradeLevel    Int
  duration      String   // "1 hour", "1 day", "1 week", etc.
  
  // Lesson plan content (JSON)
  content       Json     // Stores the full lesson plan structure
  
  // Creator
  createdBy     String
  creator       User     @relation("CreatedLessonPlans", fields: [createdBy], references: [id])
  
  // Status
  isPublished   Boolean  @default(false)
  isShared      Boolean  @default(false)
  
  // Assignments
  assignments   LessonPlanAssignment[]
  
  // Metadata
  tags          String[] @default([])
  difficulty    String?  // "easy", "medium", "hard"
  estimatedTime String?  // "30 minutes prep"
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([createdBy])
  @@index([subject, gradeLevel])
  @@map("lesson_plans")
}

model LessonPlanAssignment {
  id            String     @id @default(cuid())
  
  lessonPlanId  String
  lessonPlan    LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  
  // Assigned to student or class
  studentId     String?
  student       User?      @relation("StudentLessonAssignments", fields: [studentId], references: [id])
  
  classId       String?
  class         Class?     @relation(fields: [classId], references: [id])
  
  // Assignment settings
  assignedBy    String
  assignedByUser User      @relation("LessonAssignmentCreator", fields: [assignedBy], references: [id])
  
  dueDate       DateTime?
  completedAt   DateTime?
  isCompleted   Boolean    @default(false)
  
  // Progress tracking
  progress      Json?      // Track completion of activities
  studentNotes  String?    @db.Text
  
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  
  @@index([studentId])
  @@index([classId])
  @@index([assignedBy])
  @@map("lesson_plan_assignments")
}

// Interactive Study Materials (Like Duolingo)
model StudyModule {
  id            String   @id @default(cuid())
  title         String
  description   String?
  topic         String
  subject       String
  gradeLevel    Int
  
  // AI Generated Content
  aiGenerated   Boolean  @default(true)
  difficulty    String   @default("medium") // easy, medium, hard
  
  // Module Settings
  totalLessons  Int      @default(10)
  passingScore  Int      @default(95) // Required score to progress
  livesEnabled  Boolean  @default(true)
  maxLives      Int      @default(3)
  
  // Creator
  createdBy     String
  creator       User     @relation("CreatedStudyModules", fields: [createdBy], references: [id])
  
  // Relations
  lessons       StudyLesson[]
  assignments   StudyModuleAssignment[]
  progress      StudyProgress[]
  
  // Gamification
  xpReward      Int      @default(100)
  badgeType     String?  // Type of badge awarded on completion
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([createdBy])
  @@index([subject, gradeLevel])
  @@map("study_modules")
}

model StudyLesson {
  id            String   @id @default(cuid())
  moduleId      String
  module        StudyModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  lessonNumber  Int
  title         String
  
  // Lesson Content (AI Generated)
  content       Json     // Theory, examples, explanations
  
  // Steps in the lesson
  steps         StudyStep[]
  completedSteps CompletedStep[]
  
  // Requirements
  minScore      Int      @default(80) // Minimum score to pass
  maxAttempts   Int      @default(3)
  
  // Rewards
  xpReward      Int      @default(10)
  
  order         Int
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@unique([moduleId, lessonNumber])
  @@index([moduleId])
  @@map("study_lessons")
}

model StudyStep {
  id            String   @id @default(cuid())
  lessonId      String
  lesson        StudyLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  stepNumber    Int
  type          StepType // THEORY, PRACTICE, QUIZ, CHALLENGE
  title         String
  
  // Content
  content       Json     // Questions, explanations, interactive elements
  
  // Requirements
  passingScore  Int      @default(80)
  timeLimit     Int?     // Optional time limit in seconds
  
  // Student Progress
  attempts      StudentStepProgress[]
  
  order         Int
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@unique([lessonId, stepNumber])
  @@index([lessonId])
  @@map("study_steps")
}

// ===== Subscriptions & Payments =====

model SubscriptionTier {
  id                       String           @id @default(cuid())
  name                     String
  description              String?
  priceCents               Int              @default(0)
  currency                 String           @default("USD")
  interval                 BillingInterval  @default(MONTH)
  billingDays              Int?             @default(30) // Custom billing period in days
  examLimitPerPeriod       Int              @default(0) // 0 = unlimited
  studyModuleLimitPerPeriod Int             @default(0) // count of distinct modules per period; 0 = unlimited
  maxAttemptsPerExam       Int              @default(1)
  // Creator quotas (for TEACHER/PARENT creating content)
  creatorExamCreateLimitPerPeriod Int       @default(0) // 0 = unlimited
  creatorModuleCreateLimitPerPeriod Int     @default(0) // 0 = unlimited
  isActive                 Boolean          @default(true)

  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @updatedAt @map("updated_at")

  subscriptions            Subscription[]

  @@map("subscription_tiers")
}

model Subscription {
  id                 String              @id @default(cuid())
  userId             String
  user               User                @relation(fields: [userId], references: [id])
  tierId             String
  tier               SubscriptionTier    @relation(fields: [tierId], references: [id])
  status             SubscriptionStatus  @default(ACTIVE)
  startedAt          DateTime            @default(now())
  expiresAt          DateTime
  autoRenew          Boolean             @default(true)
  lastResetAt        DateTime            @default(now())
  examsTakenThisPeriod Int               @default(0)
  modulesAccessedThisPeriod Int          @default(0)

  // Relations
  payments           Payment[]
  moduleAccess       SubscriptionModuleAccess[]

  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")

  @@index([userId])
  @@index([tierId])
  @@map("subscriptions")
}

model Payment {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  subscriptionId String?
  subscription  Subscription?   @relation(fields: [subscriptionId], references: [id])
  provider      PaymentProvider @default(FLUTTERWAVE)
  amountCents   Int
  currency      String          @default("USD")
  status        PaymentStatus   @default(PENDING)
  txRef         String          @unique
  flwRef        String?
  raw           Json?
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([userId])
  @@map("payments")
}

model SubscriptionModuleAccess {
  id              String        @id @default(cuid())
  subscriptionId  String
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  moduleId        String
  accessedAt      DateTime      @default(now())

  @@unique([subscriptionId, moduleId])
  @@index([subscriptionId])
  @@map("subscription_module_access")
}

enum StepType {
  THEORY
  PRACTICE_EASY
  PRACTICE_MEDIUM
  PRACTICE_HARD
  QUIZ
  CHALLENGE
  REVIEW
}

model StudyModuleAssignment {
  id            String   @id @default(cuid())

  moduleId      String
  module        StudyModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  studentId     String
  student       User     @relation("StudentStudyAssignments", fields: [studentId], references: [id])

  assignedBy    String
  assignedByUser User    @relation("StudyAssignmentCreator", fields: [assignedBy], references: [id])

  // Assignment settings
  dueDate       DateTime?
  instructions  String?   @db.Text

  // Progress
  currentLesson Int      @default(1)
  currentStep   Int      @default(1)
  overallProgress Float  @default(0) // 0-100%

  // Gamification
  totalXp       Int      @default(0)
  lives         Int      @default(3)
  streak        Int      @default(0)
  lastActiveAt  DateTime?

  // Status
  status        ModuleStatus @default(IN_PROGRESS)
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  // Performance
  averageScore  Float    @default(0)
  totalAttempts Int      @default(0)

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([moduleId, studentId])
  @@index([studentId])
  @@index([assignedBy])
  @@map("study_module_assignments")
}

enum ModuleStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
}

model StudyProgress {
  id            String   @id @default(cuid())
  
  moduleId      String
  module        StudyModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  studentId     String
  student       User     @relation("StudentProgress", fields: [studentId], references: [id])
  
  // Current position
  currentLessonNumber Int @default(1)
  currentStepNumber   Int @default(1)
  
  // Gamification
  totalXP       Int      @default(0)
  livesRemaining Int     @default(3)
  streak        Int      @default(0)
  
  // Tracking
  lastAccessedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  completedSteps CompletedStep[]
  
  @@unique([moduleId, studentId])
  @@index([studentId])
  @@map("study_progress")
}

model CompletedStep {
  id            String   @id @default(cuid())
  
  progressId    String
  progress      StudyProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  lessonId      String
  lesson        StudyLesson @relation(fields: [lessonId], references: [id])
  
  stepNumber    Int
  completedAt   DateTime @default(now())
  score         Float
  timeSpent     Int      // In seconds
  
  @@unique([progressId, lessonId, stepNumber])
  @@map("completed_steps")
}

model StudentStepProgress {
  id            String   @id @default(cuid())
  
  stepId        String
  step          StudyStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  studentId     String
  student       User     @relation("StudentStepProgress", fields: [studentId], references: [id])
  
  // Attempt details
  attemptNumber Int
  score         Float
  answers       Json     // Student's answers
  timeSpent     Int      // In seconds
  
  // Status
  passed        Boolean
  
  completedAt   DateTime @default(now())
  
  @@index([stepId])
  @@index([studentId])
  @@map("student_step_progress")
}

// Subscription Tiers
model Tier {
  id                String    @id @default(cuid())
  name              String    @unique
  description       String?

  // ONLY these limits matter:
  maxExams          Int       @default(10)  // Maximum exams user can create
  maxStudyModules   Int       @default(10)  // Maximum study modules user can create
  maxStudents       Int       @default(50)  // Maximum students user can create

  // Duration
  validityDays      Int       @default(30)  // How long the tier lasts (default 30 days)

  // Pricing (for future payment integration)
  price             Float     @default(0)
  currency          String    @default("RWF")

  // Status
  isActive          Boolean   @default(true)

  // Relations
  users             UserTier[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// User's tier assignment and usage
model UserTier {
  id                String    @id @default(cuid())

  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])

  tierId            String
  tier              Tier      @relation(fields: [tierId], references: [id])

  // Usage tracking (ONLY track what we limit)
  examsCreated      Int       @default(0)
  studyModulesCreated Int     @default(0)
  studentsCreated   Int       @default(0)

  // Assignment details
  assignedBy        String?   // Admin who assigned this tier
  assignedAt        DateTime  @default(now())
  expiresAt         DateTime? // When the tier expires

  // Status
  isActive          Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([tierId])
}